{{- if .Values.metrics.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: kubetorch-metrics-config
  namespace: {{ .Release.Namespace }}
data:
  prometheus.yml: |
    global:
      scrape_interval: {{ .Values.metrics.prometheus.scrapeInterval }}
      evaluation_interval: {{ .Values.metrics.prometheus.scrapeInterval }}

    scrape_configs:
      # Prometheus itself
      - job_name: 'self'
        static_configs:
          - targets: ['localhost:{{ .Values.metrics.prometheus.port }}']

      # Kubernetes Metrics Server (multi-namespace)
      {{- $allNamespaces := .Values.kubetorchConfig.deployment_namespaces | default list }}
      {{- if not (has .Release.Namespace $allNamespaces) }}
        {{- $allNamespaces = append $allNamespaces .Release.Namespace }}
      {{- end }}
      {{- range $allNamespaces }}
      - job_name: 'metrics-server-{{ . }}'
        scheme: https
        metrics_path: /apis/metrics.k8s.io/v1beta1/namespaces/{{ . }}/pods
        static_configs:
          - targets: ['kubernetes.default.svc:443']
        tls_config:
          ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
          insecure_skip_verify: true
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
      {{- end }}

      {{- if (index .Values "dcgm-exporter").enabled }}
      # Self-managed NVIDIA DCGM Exporter
      - job_name: 'dcgm-exporter'
        kubernetes_sd_configs:
          - role: pod
        relabel_configs:
          # Only keep dcgm-exporter pods
          - source_labels: [__meta_kubernetes_pod_label_app_kubernetes_io_name]
            regex: dcgm-exporter
            action: keep

          # Only pods that expose port 9400
          - source_labels: [__meta_kubernetes_pod_container_port_number]
            regex: "9400"
            action: keep

          # These labels come from the exporter metrics themselves
          # (they refer to workload pods, not exporter pods)
          - source_labels: [__meta_kubernetes_namespace]
            target_label: exporter_namespace
          - source_labels: [__meta_kubernetes_pod_name]
            target_label: exporter_pod
      {{- else }}
      # GKE-managed DCGM Exporter
      - job_name: 'gke-managed-dcgm-exporter'
        honor_labels: true
        kubernetes_sd_configs:
          - role: pod
            namespaces:
              names: ['gke-managed-system']
        relabel_configs:
          # Match the GKE-managed DCGM pods
          - source_labels: [__meta_kubernetes_pod_label_app_kubernetes_io_name]
            regex: gke-managed-dcgm-exporter
            action: keep

          # Only containers exposing 9400
          - source_labels: [__meta_kubernetes_pod_container_port_number]
            regex: "9400"
            action: keep

          # Use pod IP as the scrape target
          - source_labels: [__meta_kubernetes_pod_ip]
            target_label: __address__
            replacement: "$1:9400"

          # Add some useful labels
          - source_labels: [__meta_kubernetes_namespace]
            target_label: namespace
          - source_labels: [__meta_kubernetes_pod_name]
            target_label: pod
        {{- end }}

      # allow for namespace filtering
      - job_name: 'pods'
        kubernetes_sd_configs:
          - role: pod
        relabel_configs:
          - source_labels: [__meta_kubernetes_namespace]
            target_label: namespace
          - source_labels: [__meta_kubernetes_pod_name]
            target_label: pod
          # derive "service" from the custom label
          - source_labels: [__meta_kubernetes_pod_label_kubetorch_com_service]
            target_label: service
          - source_labels: [__meta_kubernetes_pod_container_port_number]
            regex: "32300|8080|8000|9090"
            action: keep
{{- end }}
