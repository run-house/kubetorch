apiVersion: v1
kind: ConfigMap
metadata:
  name: kubetorch-controller-config
  namespace: {{ .Release.Namespace }}
data:
  nginx.conf: |-
    worker_processes auto;

    events {
        worker_connections 65535;
        use epoll;
        multi_accept on;
    }

    http {
        resolver {{ .Values.kubetorchController.nginx.resolver }} valid=5s;

        map $http_upgrade $connection_upgrade {
            default upgrade;
            '' close;
        }

        server {
            listen 8080;

            # -------------------------------------------------------
            # HEALTH
            # -------------------------------------------------------
            location {{ .Values.kubetorchController.nginx.healthRoute }} {
                access_log off;
                return 200 '{"status":"ok","version":"{{ .Chart.Version }}","config":{"log_streaming_enabled":{{ .Values.logStreaming.enabled }},"metrics_enabled":{{ .Values.metrics.enabled }}}}';
                add_header Content-Type text/plain;
            }

            # -------------------------------------------------------
            # CONTROLLER — MUST TAKE ABSOLUTE PRIORITY
            # -------------------------------------------------------

            location ^~ /api/ {
                proxy_pass http://localhost:{{ .Values.kubetorchController.port }};
                proxy_http_version 1.1;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                proxy_buffering off;
                proxy_request_buffering off;
                proxy_connect_timeout 60s;
                proxy_send_timeout 60s;
                proxy_read_timeout 60s;
            }

            location ^~ /apis/ {
                proxy_pass http://localhost:{{ .Values.kubetorchController.port }};
                proxy_http_version 1.1;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                proxy_buffering off;
                proxy_request_buffering off;
                proxy_connect_timeout 60s;
                proxy_send_timeout 60s;
                proxy_read_timeout 60s;
            }

            # -------------------------------------------------------
            # RSYNC
            # -------------------------------------------------------
            location ~ ^/rsync/([^/]+)/?(.*)$ {
                set $namespace $1;
                client_max_body_size {{ .Values.kubetorchController.nginx.maxBodySize.rsync }};
                # Data store service is in the same namespace as the request
                proxy_pass http://kubetorch-data-store.$namespace.svc.cluster.local:8080;
                proxy_http_version 1.1;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection $connection_upgrade;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_cache_bypass $http_upgrade;
            }

            # -------------------------------------------------------
            # METRICS
            # -------------------------------------------------------
            location ^~ /prometheus/ {
                resolver {{ .Values.kubetorchController.nginx.resolver }} valid=5s;
                set $prom_host "kubetorch-metrics.{{ .Release.Namespace }}.svc.cluster.local:{{ .Values.metrics.prometheus.port }}";
                rewrite ^/prometheus/(.*)$ /$1 break;
                proxy_pass http://$prom_host;
                proxy_http_version 1.1;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_buffering off;
            }

            # -------------------------------------------------------
            # LOGGING — LOKI (namespace-aware)
            # Routes /loki/{namespace}/... to kubetorch-data-store.{namespace}:3100/...
            # -------------------------------------------------------
            location ~ ^/loki/([^/]+)/(.*)$ {
                set $namespace $1;
                set $loki_path $2;
                resolver {{ .Values.kubetorchController.nginx.resolver }} valid=5s;
                proxy_pass http://kubetorch-data-store.$namespace.svc.cluster.local:3100/loki/$loki_path$is_args$args;
                proxy_http_version 1.1;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection $connection_upgrade;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_cache_bypass $http_upgrade;
            }

            # -------------------------------------------------------
            # CONTROLLER ROUTES — deploy, heartbeat, resources, WebSocket, etc.
            # -------------------------------------------------------
            location ^~ /controller/ {
                proxy_pass http://localhost:{{ .Values.kubetorchController.port }};
                proxy_http_version 1.1;
                # WebSocket support
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection $connection_upgrade;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                proxy_cache_bypass $http_upgrade;
                proxy_buffering off;
                proxy_request_buffering off;
                proxy_connect_timeout 60s;
                proxy_send_timeout 60s;
                # Long timeout for WebSocket connections
                proxy_read_timeout 30d;
            }

            # -------------------------------------------------------
            # DEFAULT — NAMESPACE → SERVICE PROXY
            # Format: /{namespace}/{service}:{port}{/path}
            # MUST NOT MATCH /api, /apis, or /controller
            # -------------------------------------------------------
            location ~ ^/(?!(api|apis|controller)/)([^/]+)/([^/:]+):(\d+)(/.*)?$ {
                set $namespace $2;
                set $service $3;
                set $port $4;
                set $rest $5;

                client_max_body_size {{ .Values.kubetorchController.nginx.maxBodySize.api }};

                proxy_pass http://$service.$namespace.svc.cluster.local:$port$rest$is_args$args;
                proxy_http_version 1.1;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection "upgrade";
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                proxy_buffering off;
                proxy_request_buffering off;
                proxy_connect_timeout 300s;
                proxy_send_timeout 300s;
                proxy_read_timeout 30d;
            }
          location /metrics {
            return 204;
          }
        }
    }
