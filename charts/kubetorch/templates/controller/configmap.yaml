apiVersion: v1
kind: ConfigMap
metadata:
  name: kubetorch-controller-config
  namespace: {{ .Release.Namespace }}
data:
  nginx.conf: |-
    worker_processes 1;

    events { worker_connections 1024; }

    # TCP proxying (for direct rsync)
    stream {
        upstream rsync_backend {
            server kubetorch-rsync.{{ .Release.Namespace }}.svc.cluster.local:873;
        }

        server {
            listen 8873;
            proxy_pass rsync_backend;
        }
    }

    http {
        resolver {{ .Values.nginx.resolver }} valid=5s;

        map $http_upgrade $connection_upgrade {
            default upgrade;
            '' close;
        }

        server {
            listen 8080;

            # -------------------------------------------------------
            # HEALTH
            # -------------------------------------------------------
            location {{ .Values.nginxProxy.backends.health.route }} {
                access_log off;
                return 200 '{"status":"ok","version":"{{ .Chart.Version }}","config":{"otel_enabled":{{ .Values.kubetorchConfig.otelEnabled }}}}';
                add_header Content-Type text/plain;
            }

            # -------------------------------------------------------
            # CONTROLLER — MUST TAKE ABSOLUTE PRIORITY
            # -------------------------------------------------------

            location ^~ /api/ {
                proxy_pass http://localhost:8081;
                proxy_http_version 1.1;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                proxy_buffering off;
                proxy_request_buffering off;
                proxy_connect_timeout 60s;
                proxy_send_timeout 60s;
                proxy_read_timeout 60s;
            }

            location ^~ /apis/ {
                proxy_pass http://localhost:8081;
                proxy_http_version 1.1;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                proxy_buffering off;
                proxy_request_buffering off;
                proxy_connect_timeout 60s;
                proxy_send_timeout 60s;
                proxy_read_timeout 60s;
            }

            # -------------------------------------------------------
            # RSYNC
            # -------------------------------------------------------
            location ~ ^/rsync/([^/]+)/?(.*)$ {
                set $namespace $1;
                client_max_body_size {{ .Values.nginxProxy.maxBodySize.rsync }};
                proxy_pass http://kubetorch-rsync.$namespace.svc.cluster.local:8080;
                proxy_http_version 1.1;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection $connection_upgrade;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_cache_bypass $http_upgrade;
            }

            # -------------------------------------------------------
            # METRICS
            # -------------------------------------------------------
            location ^~ /prometheus/ {
                resolver {{ .Values.nginx.resolver }} valid=5s;
                set $prom_host "kubetorch-metrics.{{ .Release.Namespace }}.svc.cluster.local:{{ .Values.metrics.prometheus.port }}";
                rewrite ^/prometheus/(.*)$ /$1 break;
                proxy_pass http://$prom_host;
                proxy_http_version 1.1;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_buffering off;
            }

            # -------------------------------------------------------
            # LOGGING — LOKI
            # -------------------------------------------------------
            location ^~ {{ .Values.nginxProxy.backends.logging.route }}/ {
                resolver {{ .Values.nginx.resolver }} valid=5s;
                set $loki_host "loki-gateway.{{ .Release.Namespace }}.svc.cluster.local:{{ .Values.logStreaming.port }}";
                proxy_pass http://$loki_host;
                proxy_http_version 1.1;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection $connection_upgrade;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_cache_bypass $http_upgrade;
            }

            # -------------------------------------------------------
            # DEFAULT — NAMESPACE → SERVICE PROXY
            # MUST NOT MATCH /api or /apis
            # -------------------------------------------------------
            location ~ ^/(?!(api|apis)/)([^/]+)/([^/]+)(/.*)?$ {
                set $namespace $2;
                set $service $3;
                set $rest $4;

                client_max_body_size {{ .Values.nginxProxy.maxBodySize.api }};

                proxy_pass http://$service.$namespace.svc.cluster.local$rest$is_args$args;
                proxy_http_version 1.1;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection "upgrade";
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                proxy_buffering off;
                proxy_request_buffering off;
                proxy_connect_timeout 300s;
                proxy_send_timeout 300s;
                proxy_read_timeout 30d;
            }
        }
    }
