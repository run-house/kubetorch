{{- if .Values.logStreaming.enabled }}
{{- $deploymentNamespaces := .Values.kubetorchConfig.deployment_namespaces | default list }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: otel-collector-config
  namespace: {{ .Release.Namespace }}
data:
  relay: |
    extensions:
      health_check:
        endpoint: 0.0.0.0:13133
    receivers:
      filelog:
        include:
        {{- range $deploymentNamespaces }}
          - /var/log/pods/{{ . }}_*/*/*.log
        {{- end }}
        exclude:
          - /var/log/pods/*/otel-collector/*.log
          - /var/log/pods/*/opentelemetry-collector/*.log
        start_at: end
        include_file_path: true
        include_file_name: false
        operators:
          - type: container
            id: container-parser
      k8s_events:
        namespaces:
        {{- range $deploymentNamespaces }}
          - {{ . }}
        {{- end }}
    processors:
      batch:
        timeout: 200ms
        send_batch_size: 1
        send_batch_max_size: 1
      k8sattributes:
        extract:
          metadata:
            - k8s.namespace.name
            - k8s.pod.name
            - k8s.container.name
    connectors:
      routing:
        default_pipelines: [logs/fallback]
        error_mode: ignore
        table:
        {{- range $deploymentNamespaces }}
          - statement: route() where resource.attributes["k8s.namespace.name"] == "{{ . }}"
            pipelines: [logs/{{ . }}]
        {{- end }}
    exporters:
      {{- range $deploymentNamespaces }}
      otlphttp/{{ . }}:
        endpoint: "http://kubetorch-data-store.{{ . }}.svc.cluster.local:3100/otlp"
        tls:
          insecure: true
      {{- end }}
      # Fallback exporter for logs that don't match any namespace (should not happen)
      debug:
        verbosity: basic
    service:
      extensions: [health_check]
      telemetry:
        logs:
          level: warn
      pipelines:
        logs/ingestion:
          receivers: [filelog, k8s_events]
          processors: [k8sattributes, batch]
          exporters: [routing]
        {{- range $deploymentNamespaces }}
        logs/{{ . }}:
          receivers: [routing]
          exporters: [otlphttp/{{ . }}]
        {{- end }}
        logs/fallback:
          receivers: [routing]
          exporters: [debug]
{{- end }}
