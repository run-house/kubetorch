---
# KubetorchWorkload CRD - Represents a logical compute workload
#
# A workload is a group of pods that can receive calls and execute user code.
#
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: kubetorchworkloads.kubetorch.com
  labels:
    app.kubernetes.io/name: kubetorch
    app.kubernetes.io/component: controller
  annotations:
    helm.sh/resource-policy: keep # Prevent CRD from being deleted by Helm
spec:
  group: kubetorch.com
  names:
    kind: KubetorchWorkload
    listKind: KubetorchWorkloadList
    plural: kubetorchworkloads
    singular: kubetorchworkload
    shortNames:
      - ktworkload
      - ktworkloads
  scope: Namespaced
  versions:
    - name: v1alpha1
      served: true
      storage: true
      schema:
        openAPIV3Schema:
          type: object
          required:
            - spec
          properties:
            apiVersion:
              type: string
            kind:
              type: string
            metadata:
              type: object
            spec:
              type: object
              required:
                - selector
              properties:
                selector:
                  type: object
                  description: Label selector to identify pods in this workload
                  additionalProperties:
                    type: string
                serviceConfig:
                  type: object
                  description: How to route traffic to this workload
                  properties:
                    url:
                      type: string
                      description: User-provided service URL (e.g., Knative)
                    selector:
                      type: object
                      description: Custom selector for routing (e.g., Ray head only)
                      additionalProperties:
                        type: string
                    name:
                      type: string
                      description: Custom service name
                module:
                  type: object
                  description: Code/application deployed on this workload
                  properties:
                    type:
                      type: string
                      description: Module type
                      enum:
                        - fn
                        - cls
                        - cmd
                        - app
                    dispatch:
                      type: string
                      description: Call dispatch mode
                      enum:
                        - regular
                        - spmd
                        - load_balanced
                      default: regular
                    procs:
                      description: Number of processes or process indices
                      x-kubernetes-int-or-string: true
                    pointers:
                      type: object
                      description: Information to locate and load the callable
                      properties:
                        filePath:
                          type: string
                          description: Path to the Python file
                        moduleName:
                          type: string
                          description: Python module name
                        clsOrFnName:
                          type: string
                          description: Class or function name
                        projectRoot:
                          type: string
                          description: Root directory for imports
                        initArgs:
                          type: object
                          description: Arguments for initialization
                          x-kubernetes-preserve-unknown-fields: true
                autoTermination:
                  type: object
                  description: Auto-termination policies for this workload
                  properties:
                    inactivityTtl:
                      type: string
                      description: Terminate after this duration of inactivity (e.g., 30m, 1h, 1d)
                    # Future expansion:
                    # maxDuration:
                    #   type: string
                    #   description: Maximum lifetime regardless of activity
                    # gpuIdleThreshold:
                    #   type: object
                    #   description: Terminate when GPU utilization falls below threshold
                workloadMetadata:
                  type: object
                  description: Metadata about the workload deployment
                  properties:
                    username:
                      type: string
                      description: User who created this workload
                    deploymentMode:
                      type: string
                      description: How the workload was deployed (serverless, persistent, distributed, byo)
                    distributedConfig:
                      type: object
                      description: Configuration for distributed workloads
                      x-kubernetes-preserve-unknown-fields: true
                    launchId:
                      type: string
                      description: Unique ID for this launch/deployment (changes on each .to() call)
                    dockerfile:
                      type: string
                      description: Dockerfile contents for image build
                    runtimeConfig:
                      type: object
                      description: Runtime settings pushed to pods
                      properties:
                        logStreamingEnabled:
                          type: boolean
                          default: true
                        metricsEnabled:
                          type: boolean
                          default: true
                        logLevel:
                          type: string
                          description: Python log level
                        allowedSerialization:
                          type: string
                          description: Serialization mode
                serverPort:
                  type: integer
                  description: Port pods listen on
                  default: 32300
                resourceKind:
                  type: string
                  description: K8s resource type backing this workload (Deployment, PyTorchJob, etc.)
                resourceName:
                  type: string
                  description: Name of the backing K8s resource
                createHeadlessService:
                  type: boolean
                  description: Create headless service for pod-to-pod discovery
                  default: false
                readinessPolicy:
                  type: object
                  description: Defines when this workload is considered ready
                  properties:
                    strategy:
                      type: string
                      description: How to evaluate readiness
                      enum:
                        - AllPodsReady
                        - MinPodsReady
                        - AnyPodReady
                      default: AllPodsReady
                    minReadyPods:
                      type: integer
                      description: Minimum pods that must be Ready (used with MinPodsReady strategy)
                      minimum: 1
                    healthCheckEndpoint:
                      type: string
                      description: Endpoint to probe on serviceUrl (default /ready). Override for custom health checks.
            status:
              type: object
              properties:
                serviceUrl:
                  type: string
                  description: URL to reach this workload
                podIps:
                  type: array
                  description: IPs of connected pods
                  items:
                    type: string
                podCount:
                  type: integer
                  description: Number of pods matching selector
                readyPodCount:
                  type: integer
                  description: Number of pods with Ready condition
                expectedPodCount:
                  type: integer
                  description: Expected number of pods (derived from backing resource)
                ready:
                  type: boolean
                  description: Whether workload meets readiness policy
                readyLaunchId:
                  type: string
                  description: The launchId that readiness was verified against
                lastDeployedAt:
                  type: string
                  format: date-time
                  description: Timestamp of last module deployment
                error:
                  type: object
                  description: Current error state (null if no error)
                  properties:
                    type:
                      type: string
                      description: Error classification
                      enum:
                        - ImagePullError
                        - CrashLoopBackOff
                        - OOMKilled
                        - ResourceNotAvailable
                        - StartupError
                        - FailedMount
                        - ContainerError
                        - Unknown
                    message:
                      type: string
                      description: Human-readable error message
                    reason:
                      type: string
                      description: Kubernetes reason code (e.g., ImagePullBackOff)
                    podName:
                      type: string
                      description: Name of the affected pod
                    containerName:
                      type: string
                      description: Name of the affected container
                    timestamp:
                      type: string
                      format: date-time
                      description: When the error was detected
                conditions:
                  type: array
                  description: Standard K8s conditions
                  items:
                    type: object
                    properties:
                      type:
                        type: string
                      status:
                        type: string
                        enum:
                          - "True"
                          - "False"
                          - "Unknown"
                      lastTransitionTime:
                        type: string
                        format: date-time
                      reason:
                        type: string
                      message:
                        type: string
      subresources:
        status: {}
      additionalPrinterColumns:
        - name: Ready
          type: boolean
          jsonPath: .status.ready
        - name: Ready Pods
          type: integer
          jsonPath: .status.readyPodCount
        - name: Expected
          type: integer
          jsonPath: .status.expectedPodCount
        - name: Resource
          type: string
          jsonPath: .spec.resourceKind
        - name: User
          type: string
          jsonPath: .spec.workloadMetadata.username
        - name: Error
          type: string
          jsonPath: .status.error.type
          priority: 1
        - name: TTL
          type: string
          jsonPath: .spec.autoTermination.inactivityTtl
          priority: 1
        - name: Service URL
          type: string
          jsonPath: .status.serviceUrl
          priority: 1
        - name: Age
          type: date
          jsonPath: .metadata.creationTimestamp
