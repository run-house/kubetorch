name: Nightly GPU Tests

on:
  workflow_dispatch:
  schedule:
    # Run every night at 2 AM UTC
    - cron: '0 2 * * *'

env:
  CI: true
  KUBETORCH_IGNORE_VERSION_MISMATCH: 1

jobs:
  gpu-tests:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Check out repository code
        uses: actions/checkout@v3

      - name: Install Basic Dependencies
        uses: ./.github/workflows/install_basic_dependencies

      - name: Setup authentications
        uses: ./.github/workflows/gke_authentications
        with:
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          GCP_WORKLOAD_IDENTITY_PROVIDER: ${{ secrets.GOOGLE_WORKLOAD_IDENTITY_PROVIDER }}

      - name: Setup Test Cluster
        uses: ./.github/workflows/setup_test_cluster
        with:
          KUBECONFIG: ${{ secrets.KUBECONFIG }}

      - name: Get GKE credentials
        run: |
          gcloud container clusters get-credentials ${{ secrets.CI_CLUSTER_NAME }} \
            --region ${{ secrets.CI_CLUSTER_REGION }} \
            --project ${{ secrets.GCP_PROJECT_ID }}

      - name: Set Python Source Root
        run: echo "PYTHONPATH=$(pwd)/python_client" >> $GITHUB_ENV

      - name: Set Test Hash
        run: |
          TEST_HASH="t-$(echo $GITHUB_SHA | cut -c1-5)-gpu"
          echo "TEST_HASH=$TEST_HASH" >> $GITHUB_ENV
          echo "Using test hash $TEST_HASH"

      - name: Update kt config with controller test namespace, if exists
        shell: bash
        run: |
          BRANCH="${GITHUB_HEAD_REF:-$GITHUB_REF_NAME}"
          PREFIX=$(echo "$BRANCH" | cut -d'/' -f1)
          NAMESPACE=$(echo "$PREFIX" | tr '[:upper:]' '[:lower:]' | sed 's#[^a-z0-9]#-#g' | sed 's/--*/-/g' | sed 's/^-//;s/-$//' | cut -c1-63)
          echo "NAMESPACE=$NAMESPACE" >> $GITHUB_OUTPUT

          # Check if namespace exists
          if kubectl get namespace "$NAMESPACE" >/dev/null 2>&1; then
            echo "Namespace $NAMESPACE exists, setting kt config"
            kt config set namespace "$NAMESPACE"
            kt config set install_namespace "$NAMESPACE"
          else
            echo "Namespace $NAMESPACE does not exist, kt config remains unchanged"
          fi

      - name: Run tests with level minimal
        run: |
          cd python_client
          pytest -v --durations=25 --level minimal -m "gpu_test"
        timeout-minutes: 60
        env:
          KT_STREAM_LOGS: false
          KT_STREAM_METRICS: false

  cleanup:
    if: ${{ always() }}
    needs: gpu-tests
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout repository code
        uses: actions/checkout@v3

      - name: Install Basic Dependencies
        uses: ./.github/workflows/install_basic_dependencies

      - name: Setup authentications
        uses: ./.github/workflows/gke_authentications
        with:
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          GCP_WORKLOAD_IDENTITY_PROVIDER: ${{ secrets.GOOGLE_WORKLOAD_IDENTITY_PROVIDER }}

      - name: Setup Test Cluster
        uses: ./.github/workflows/setup_test_cluster
        with:
          KUBECONFIG: ${{ secrets.KUBECONFIG }}

      - name: Set Test Hash
        run: |
          TEST_HASH="t-$(echo $GITHUB_SHA | cut -c1-5)-gpu"
          echo "TEST_HASH=$TEST_HASH" >> $GITHUB_ENV
          echo "Using test hash $TEST_HASH"

      - name: Update kt config with controller test namespace, if exists
        shell: bash
        run: |
          BRANCH="${GITHUB_HEAD_REF:-$GITHUB_REF_NAME}"
          PREFIX=$(echo "$BRANCH" | cut -d'/' -f1)
          NAMESPACE=$(echo "$PREFIX" | tr '[:upper:]' '[:lower:]' | sed 's#[^a-z0-9]#-#g' | sed 's/--*/-/g' | sed 's/^-//;s/-$//' | cut -c1-63)
          echo "NAMESPACE=$NAMESPACE" >> $GITHUB_OUTPUT

          # Check if namespace exists
          if kubectl get namespace "$NAMESPACE" >/dev/null 2>&1; then
            echo "Namespace $NAMESPACE exists, setting kt config"
            kt config set namespace "$NAMESPACE"
            kt config set install_namespace "$NAMESPACE"
          else
            echo "Namespace $NAMESPACE does not exist, kt config remains unchanged"
          fi

      - name: Run Teardown Commands
        run: |
          echo "Running teardown command: kt teardown --prefix ${TEST_HASH}${suffix} -y"
          kt teardown --prefix ${TEST_HASH}${suffix} -y || true
          echo "Running teardown command: kt teardown --prefix ${TEST_HASH}${suffix} --namespace test-${TEST_HASH}${suffix} -y"
          kt teardown --prefix ${TEST_HASH}${suffix} --namespace test-${TEST_HASH}${suffix} -y || true
          echo "Running secrets delete command: kt secrets delete --prefix ${TEST_HASH}${suffix} -y"
          kt secrets delete --prefix ${TEST_HASH}${suffix} -y || true
          echo "Running secrets delete command: kt secrets delete --prefix ${TEST_HASH}${suffix} --namespace test-${TEST_HASH}${suffix} -y"
          kt secrets delete --prefix ${TEST_HASH}${suffix} --namespace test-${TEST_HASH}${suffix} -y || true
