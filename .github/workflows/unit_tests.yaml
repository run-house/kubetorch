name: Unit tests

on:
  push:
    branches: [ main ]
    paths-ignore:
      - 'python_client/kubetorch/docs/**'
      - 'python_client/tests/test_deploy.py'
      - '**/*.md'
      - '**/*.rst'
      - '**/*.tf'
      - 'exploratory/**'
      - 'cluster_setup/**'
      - '.github/workflows/create_cluster.yaml'
      - '.github/workflows/deploy_tests.yaml'
      - '.github/workflows/create_cluster/action.yaml'
      - '.github/workflows/delete_cluster.yaml'
  pull_request:
    paths-ignore:
      - 'python_client/kubetorch/docs/**'
      - 'python_client/tests/test_deploy.py'
      - '**/*.md'
      - '**/*.rst'
      - '**/*.tf'
      - 'exploratory/**'
      - 'cluster_setup/**'
      - '.github/workflows/create_cluster.yaml'
      - '.github/workflows/deploy_tests.yaml'
      - '.github/workflows/create_cluster/action.yaml'
      - '.github/workflows/delete_cluster.yaml'
  workflow_dispatch:

env:
  CI: true

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  unit-tests:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Check out repository code
        uses: actions/checkout@v3

      - name: Install Basic Dependencies
        uses: ./.github/workflows/install_basic_dependencies

      - name: Install Additional Dependencies
        uses: ./.github/workflows/install_additional_dependencies

      - name: Setup authentications
        uses: ./.github/workflows/gke_authentications
        with:
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          GCP_WORKLOAD_IDENTITY_PROVIDER: ${{ secrets.GOOGLE_WORKLOAD_IDENTITY_PROVIDER }}

      - name: Install docs requirements
        run: pip install -r python_client/kubetorch/docs/requirements.txt

      - name: Setup Test Cluster
        uses: ./.github/workflows/setup_test_cluster
        with:
          KUBECONFIG: ${{ secrets.KUBECONFIG }}

      - name: Get GKE credentials
        run: |
          gcloud container clusters get-credentials ${{ secrets.CI_CLUSTER_NAME }} \
            --region ${{ secrets.CI_CLUSTER_REGION }} \
            --project ${{ secrets.GCP_PROJECT_ID }}

      - name: Set Python Source Root
        run: echo "PYTHONPATH=$(pwd)/python_client" >> $GITHUB_ENV

      - name: Set Test Hash
        run: |
          TEST_HASH="t-$(echo $GITHUB_SHA | cut -c1-5)"
          echo "TEST_HASH=$TEST_HASH" >> $GITHUB_ENV

      - name: Configure test namespace RBAC
        run: |
          TEST_NS="kt-test-$TEST_HASH"
          echo "Creating test namespace $TEST_NS and configuring RBAC..."
          kubectl create namespace $TEST_NS --dry-run=client -o yaml | kubectl apply -f -

          # Create Role for the test namespace
          kubectl apply -f - <<EOF
          apiVersion: rbac.authorization.k8s.io/v1
          kind: Role
          metadata:
            name: kubetorch-controller-role-$TEST_NS
            namespace: $TEST_NS
          rules:
            - apiGroups: [""]
              resources: ["persistentvolumeclaims", "pods", "services", "configmaps", "secrets", "events"]
              verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
            - apiGroups: [""]
              resources: ["pods/exec", "pods/log"]
              verbs: ["create", "get"]
            - apiGroups: ["apps"]
              resources: ["deployments", "deployments/status", "replicasets", "replicasets/status"]
              verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
            - apiGroups: ["networking.k8s.io"]
              resources: ["ingresses"]
              verbs: ["get", "list", "watch"]
          ---
          apiVersion: rbac.authorization.k8s.io/v1
          kind: RoleBinding
          metadata:
            name: kubetorch-controller-rolebinding-$TEST_NS
            namespace: $TEST_NS
          roleRef:
            apiGroup: rbac.authorization.k8s.io
            kind: Role
            name: kubetorch-controller-role-$TEST_NS
          subjects:
            - kind: ServiceAccount
              name: kubetorch-controller
              namespace: kubetorch
          EOF

      - name: Run tests with level unit
        run: |
          cd python_client
          pytest -v --level unit --detached
        timeout-minutes: 60
        env:
          client_id: "my-client-id"
          client_secret: "my-client-secret"

      - name: secrets cleanup
        if: ${{ always() }}
        run: |
          echo "Running teardown command: kt secrets delete -A -y for username ${TEST_HASH}"
          kt config set username $TEST_HASH
          kt secrets delete -A -y
        timeout-minutes: 60
