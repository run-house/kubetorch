name: Minimal tests

on:
  push:
    branches: [ main ]
    paths-ignore:
      - 'python_client/kubetorch/docs/**'
      - 'python_client/tests/test_deploy.py'
      - '**/*.md'
      - '**/*.rst'
      - '**/*.tf'
      - 'exploratory/**'
      - 'cluster_setup/**'
      - '.github/workflows/create_cluster.yaml'
      - '.github/workflows/deploy_tests.yaml'
      - '.github/workflows/create_cluster/action.yaml'
      - '.github/workflows/delete_cluster.yaml'

  pull_request:
    paths-ignore:
      - 'python_client/kubetorch/docs/**'
      - 'python_client/tests/test_deploy.py'
      - '**/*.md'
      - '**/*.rst'
      - '**/*.tf'
      - 'exploratory/**'
      - 'cluster_setup/**'
      - '.github/workflows/create_cluster.yaml'
      - '.github/workflows/deploy_tests.yaml'
      - '.github/workflows/create_cluster/action.yaml'
      - '.github/workflows/delete_cluster.yaml'
  workflow_dispatch:

env:
  CI: true
  KUBETORCH_IGNORE_VERSION_MISMATCH: 1

jobs:
  cli-tests:
    concurrency:
      group: cli-${{ github.ref }}
      cancel-in-progress: true
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Check out repository code
        uses: actions/checkout@v3

      - name: Install Basic Dependencies
        uses: ./.github/workflows/install_basic_dependencies

      - name: Setup authentications
        uses: ./.github/workflows/gke_authentications
        with:
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          GCP_WORKLOAD_IDENTITY_PROVIDER: ${{ secrets.GOOGLE_WORKLOAD_IDENTITY_PROVIDER }}

      - name: Setup Test Cluster
        uses: ./.github/workflows/setup_test_cluster
        with:
          KUBECONFIG: ${{ secrets.KUBECONFIG }}

      - name: Get GKE credentials
        run: |
          gcloud container clusters get-credentials ${{ secrets.CI_CLUSTER_NAME }} \
            --region ${{ secrets.CI_CLUSTER_REGION }} \
            --project ${{ secrets.GCP_PROJECT_ID }}

      - name: Set Python Source Root
        run: echo "PYTHONPATH=$(pwd)/python_client" >> $GITHUB_ENV

      - name: Set Test Hash
        run: |
          TEST_HASH="t-$(echo $GITHUB_SHA | cut -c1-5)-cli"
          echo "TEST_HASH=$TEST_HASH" >> $GITHUB_ENV
          echo "Using test hash $TEST_HASH"

      - name: Generate Namespace value from branch name
        shell: bash
        id: generate_ns
        run: |
          BRANCH="${GITHUB_HEAD_REF:-$GITHUB_REF_NAME}"

          # create namespace only of the branch in in a format {namespace}---{featurename}".
          # Namespace will be {namespace}

          if [[ "$BRANCH" == *"---"* ]]; then
            # Get part before '---'
            NAMESPACE="${BRANCH%%---*}"
            # If branch has a slash (e.g., sb/prefix---feature), keep what's after '/'
            NAMESPACE="${NAMESPACE##*/}"
          else
            NAMESPACE="${BRANCH##*/}"
          fi

          # Sanitize for k8s namespace
          NAMESPACE=$(echo "$NAMESPACE" \
            | tr '[:upper:]' '[:lower:]' \
            | sed 's#[^a-z0-9]#-#g' \
            | sed 's/--*/-/g' \
            | sed 's/^-//;s/-$//' \
            | cut -c1-63)

          echo "NAMESPACE=$NAMESPACE" >> $GITHUB_OUTPUT

      - name: Update kt config with controller test namespace, if exists
        shell: bash
        id: controller-ns
        run: |

          NAMESPACE=${{ steps.generate_ns.outputs.NAMESPACE }}

          # Check if namespace exists
          if kubectl get namespace "$NAMESPACE" >/dev/null 2>&1; then
            echo "Namespace $NAMESPACE exists, setting kt config"
            kt config set namespace "$NAMESPACE"
            kt config set install_namespace "$NAMESPACE"
          else
            echo "Namespace $NAMESPACE does not exist, kt config remains unchanged"
          fi

      - name: Configure test namespace RBAC
        run: |
          TEST_NS="kt-test-$TEST_HASH"
          echo "Creating test namespace $TEST_NS and configuring RBAC..."
          kubectl create namespace $TEST_NS --dry-run=client -o yaml | kubectl apply -f -

          # Use controller-ns output or fallback to 'kubetorch' (service account setup)
          CONTROLLER_NS="${{ steps.controller-ns.outputs.NAMESPACE }}"
          CONTROLLER_NS="${CONTROLLER_NS:-kubetorch}"

          # Create Role for the test namespace
          kubectl apply -f - <<EOF
          apiVersion: rbac.authorization.k8s.io/v1
          kind: Role
          metadata:
            name: kubetorch-controller-role-$TEST_NS
            namespace: $TEST_NS
          rules:
            - apiGroups: [""]
              resources: ["persistentvolumeclaims", "pods", "services", "configmaps", "secrets", "events"]
              verbs: ["get", "list", "watch", "create", "update", "patch", "delete", "deletecollection"]
            - apiGroups: [""]
              resources: ["pods/exec", "pods/log"]
              verbs: ["create", "get"]
            - apiGroups: ["apps"]
              resources: ["deployments", "deployments/status", "replicasets", "replicasets/status"]
              verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
            - apiGroups: ["networking.k8s.io"]
              resources: ["ingresses"]
              verbs: ["get", "list", "watch"]
          ---
          apiVersion: rbac.authorization.k8s.io/v1
          kind: RoleBinding
          metadata:
            name: kubetorch-controller-rolebinding-$TEST_NS
            namespace: $TEST_NS
          roleRef:
            apiGroup: rbac.authorization.k8s.io
            kind: Role
            name: kubetorch-controller-role-$TEST_NS
          subjects:
            - kind: ServiceAccount
              name: kubetorch-controller
              namespace: $CONTROLLER_NS
          EOF

      - name: Run cli tests
        run: |
          cd python_client
          pytest tests/test_cli.py -v --level minimal -m "not gpu_test"
        timeout-minutes: 60
        env:
          KT_STREAM_LOGS: false
          KT_STREAM_METRICS: false

  monitoring-tests:
    concurrency:
      group: monitoring-${{ github.ref }}
      cancel-in-progress: true
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Check out repository code
        uses: actions/checkout@v3

      - name: Install Basic Dependencies
        uses: ./.github/workflows/install_basic_dependencies

      - name: Install Additional Dependencies
        uses: ./.github/workflows/install_additional_dependencies

      - name: Setup authentications
        uses: ./.github/workflows/gke_authentications
        with:
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          GCP_WORKLOAD_IDENTITY_PROVIDER: ${{ secrets.GOOGLE_WORKLOAD_IDENTITY_PROVIDER }}

      - name: Setup Test Cluster
        uses: ./.github/workflows/setup_test_cluster
        with:
          KUBECONFIG: ${{ secrets.KUBECONFIG }}

      - name: Get GKE credentials
        run: |
          gcloud container clusters get-credentials ${{ secrets.CI_CLUSTER_NAME }} \
            --region ${{ secrets.CI_CLUSTER_REGION }} \
            --project ${{ secrets.GCP_PROJECT_ID }}

      - name: Set Test Hash
        run: |
          TEST_HASH="t-$(echo $GITHUB_SHA | cut -c1-5)-mon"
          echo "TEST_HASH=$TEST_HASH" >> $GITHUB_ENV
          echo "Using test hash $TEST_HASH"

      - name: Set Python Source Root
        run: echo "PYTHONPATH=$(pwd)/python_client" >> $GITHUB_ENV

      - name: Generate Namespace value from branch name
        shell: bash
        id: generate_ns
        run: |
          BRANCH="${GITHUB_HEAD_REF:-$GITHUB_REF_NAME}"

          # create namespace only of the branch in in a format {namespace}---{featurename}".
          # Namespace will be {namespace}

          if [[ "$BRANCH" == *"---"* ]]; then
            # Get part before '---'
            NAMESPACE="${BRANCH%%---*}"
            # If branch has a slash (e.g., sb/prefix---feature), keep what's after '/'
            NAMESPACE="${NAMESPACE##*/}"
          else
            NAMESPACE="${BRANCH##*/}"
          fi

          # Sanitize for k8s namespace
          NAMESPACE=$(echo "$NAMESPACE" \
            | tr '[:upper:]' '[:lower:]' \
            | sed 's#[^a-z0-9]#-#g' \
            | sed 's/--*/-/g' \
            | sed 's/^-//;s/-$//' \
            | cut -c1-63)

          echo "NAMESPACE=$NAMESPACE" >> $GITHUB_OUTPUT

      - name: Update kt config with controller test namespace, if exists
        shell: bash
        id: controller-ns
        run: |

          NAMESPACE=${{ steps.generate_ns.outputs.NAMESPACE }}

          # Check if namespace exists
          if kubectl get namespace "$NAMESPACE" >/dev/null 2>&1; then
            echo "Namespace $NAMESPACE exists, setting kt config"
            kt config set namespace "$NAMESPACE"
            kt config set install_namespace "$NAMESPACE"
          else
            echo "Namespace $NAMESPACE does not exist, kt config remains unchanged"
          fi

      - name: Run monitoring tests
        run: |
          cd python_client
          pytest -v --durations=25 --level minimal -k "monitoring" -m "not gpu_test"
        timeout-minutes: 60
        env:
          KT_STREAM_LOGS: true
          KT_STREAM_METRICS: true

  pod-from-pod-tests:
    concurrency:
      group: pod-from-pod-${{ github.ref }}
      cancel-in-progress: true
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Check out repository code
        uses: actions/checkout@v3

      - name: Install Basic Dependencies
        uses: ./.github/workflows/install_basic_dependencies

      - name: Setup authentications
        uses: ./.github/workflows/gke_authentications
        with:
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          GCP_WORKLOAD_IDENTITY_PROVIDER: ${{ secrets.GOOGLE_WORKLOAD_IDENTITY_PROVIDER }}

      - name: Setup Test Cluster
        uses: ./.github/workflows/setup_test_cluster
        with:
          KUBECONFIG: ${{ secrets.KUBECONFIG }}

      - name: Get GKE credentials
        run: |
          gcloud container clusters get-credentials ${{ secrets.CI_CLUSTER_NAME }} \
            --region ${{ secrets.CI_CLUSTER_REGION }} \
            --project ${{ secrets.GCP_PROJECT_ID }}

      - name: Set Python Source Root
        run: echo "PYTHONPATH=$(pwd)/python_client" >> $GITHUB_ENV

      - name: Set Test Hash
        run: |
          TEST_HASH="t-$(echo $GITHUB_SHA | cut -c1-5)-pod"
          echo "TEST_HASH=$TEST_HASH" >> $GITHUB_ENV

      - name: Generate Namespace value from branch name
        shell: bash
        id: generate_ns
        run: |
          BRANCH="${GITHUB_HEAD_REF:-$GITHUB_REF_NAME}"

          # create namespace only of the branch in in a format {namespace}---{featurename}".
          # Namespace will be {namespace}

          if [[ "$BRANCH" == *"---"* ]]; then
            # Get part before '---'
            NAMESPACE="${BRANCH%%---*}"
            # If branch has a slash (e.g., sb/prefix---feature), keep what's after '/'
            NAMESPACE="${NAMESPACE##*/}"
          else
            NAMESPACE="${BRANCH##*/}"
          fi

          # Sanitize for k8s namespace
          NAMESPACE=$(echo "$NAMESPACE" \
            | tr '[:upper:]' '[:lower:]' \
            | sed 's#[^a-z0-9]#-#g' \
            | sed 's/--*/-/g' \
            | sed 's/^-//;s/-$//' \
            | cut -c1-63)

          echo "NAMESPACE=$NAMESPACE" >> $GITHUB_OUTPUT

      - name: Update kt config with controller test namespace, if exists
        shell: bash
        id: controller-ns
        run: |

          NAMESPACE=${{ steps.generate_ns.outputs.NAMESPACE }}

          # Check if namespace exists
          if kubectl get namespace "$NAMESPACE" >/dev/null 2>&1; then
            echo "Namespace $NAMESPACE exists, setting kt config"
            kt config set namespace "$NAMESPACE"
            kt config set install_namespace "$NAMESPACE"
          else
            echo "Namespace $NAMESPACE does not exist, kt config remains unchanged"
          fi

      - name: Run pod-from-pod tests
        run: |
          cd python_client
          pytest -v tests/test_pod_from_pod.py --durations=25 --level minimal -m "not gpu_test"
        timeout-minutes: 60
        env:
          KT_STREAM_LOGS: false
          KT_STREAM_METRICS: false

  distributed-tests:
    concurrency:
      group: distributed-${{ github.ref }}
      cancel-in-progress: true
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Check out repository code
        uses: actions/checkout@v3

      - name: Install Basic Dependencies
        uses: ./.github/workflows/install_basic_dependencies

      - name: Install Additional Dependencies
        uses: ./.github/workflows/install_additional_dependencies

      - name: Install Ray
        run: |
          uv pip install --system ray

      - name: Setup authentications
        uses: ./.github/workflows/gke_authentications
        with:
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          GCP_WORKLOAD_IDENTITY_PROVIDER: ${{ secrets.GOOGLE_WORKLOAD_IDENTITY_PROVIDER }}

      - name: Setup Test Cluster
        uses: ./.github/workflows/setup_test_cluster
        with:
          KUBECONFIG: ${{ secrets.KUBECONFIG }}

      - name: Get GKE credentials
        run: |
          gcloud container clusters get-credentials ${{ secrets.CI_CLUSTER_NAME }} \
            --region ${{ secrets.CI_CLUSTER_REGION }} \
            --project ${{ secrets.GCP_PROJECT_ID }}

      - name: Set Python Source Root
        run: echo "PYTHONPATH=$(pwd)/python_client" >> $GITHUB_ENV

      - name: Set Test Hash
        run: |
          TEST_HASH="t-$(echo $GITHUB_SHA | cut -c1-5)-dist"
          echo "TEST_HASH=$TEST_HASH" >> $GITHUB_ENV

      - name: Generate Namespace value from branch name
        shell: bash
        id: generate_ns
        run: |
          BRANCH="${GITHUB_HEAD_REF:-$GITHUB_REF_NAME}"

          # create namespace only of the branch in in a format {namespace}---{featurename}".
          # Namespace will be {namespace}

          if [[ "$BRANCH" == *"---"* ]]; then
            # Get part before '---'
            NAMESPACE="${BRANCH%%---*}"
            # If branch has a slash (e.g., sb/prefix---feature), keep what's after '/'
            NAMESPACE="${NAMESPACE##*/}"
          else
            NAMESPACE="${BRANCH##*/}"
          fi

          # Sanitize for k8s namespace
          NAMESPACE=$(echo "$NAMESPACE" \
            | tr '[:upper:]' '[:lower:]' \
            | sed 's#[^a-z0-9]#-#g' \
            | sed 's/--*/-/g' \
            | sed 's/^-//;s/-$//' \
            | cut -c1-63)

          echo "NAMESPACE=$NAMESPACE" >> $GITHUB_OUTPUT

      - name: Update kt config with controller test namespace, if exists
        shell: bash
        id: controller-ns
        run: |

          NAMESPACE=${{ steps.generate_ns.outputs.NAMESPACE }}

          # Check if namespace exists
          if kubectl get namespace "$NAMESPACE" >/dev/null 2>&1; then
            echo "Namespace $NAMESPACE exists, setting kt config"
            kt config set namespace "$NAMESPACE"
            kt config set install_namespace "$NAMESPACE"
          else
            echo "Namespace $NAMESPACE does not exist, kt config remains unchanged"
          fi

      - name: Run distributed tests
        run: |
          cd python_client
          pytest -v tests/test_distributed.py --durations=25 --level minimal -m "not gpu_test"
        timeout-minutes: 60
        env:
          KT_STREAM_LOGS: true
          KT_STREAM_METRICS: false

  python-path-tests:
    concurrency:
      group: python-path-${{ github.ref }}
      cancel-in-progress: true
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Check out repository code
        uses: actions/checkout@v3

      - name: Install Basic Dependencies
        uses: ./.github/workflows/install_basic_dependencies

      - name: Setup authentications
        uses: ./.github/workflows/gke_authentications
        with:
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          GCP_WORKLOAD_IDENTITY_PROVIDER: ${{ secrets.GOOGLE_WORKLOAD_IDENTITY_PROVIDER }}

      - name: Setup Test Cluster
        uses: ./.github/workflows/setup_test_cluster
        with:
          KUBECONFIG: ${{ secrets.KUBECONFIG }}

      - name: Get GKE credentials
        run: |
          gcloud container clusters get-credentials ${{ secrets.CI_CLUSTER_NAME }} \
            --region ${{ secrets.CI_CLUSTER_REGION }} \
            --project ${{ secrets.GCP_PROJECT_ID }}

      - name: Set Python Source Root
        run: echo "PYTHONPATH=$(pwd)/python_client" >> $GITHUB_ENV

      - name: Set Test Hash
        run: |
          TEST_HASH="t-$(echo $GITHUB_SHA | cut -c1-5)-python"
          echo "TEST_HASH=$TEST_HASH" >> $GITHUB_ENV

      - name: Generate Namespace value from branch name
        shell: bash
        id: generate_ns
        run: |
          BRANCH="${GITHUB_HEAD_REF:-$GITHUB_REF_NAME}"

          # create namespace only of the branch in in a format {namespace}---{featurename}".
          # Namespace will be {namespace}

          if [[ "$BRANCH" == *"---"* ]]; then
            # Get part before '---'
            NAMESPACE="${BRANCH%%---*}"
            # If branch has a slash (e.g., sb/prefix---feature), keep what's after '/'
            NAMESPACE="${NAMESPACE##*/}"
          else
            NAMESPACE="${BRANCH##*/}"
          fi

          # Sanitize for k8s namespace
          NAMESPACE=$(echo "$NAMESPACE" \
            | tr '[:upper:]' '[:lower:]' \
            | sed 's#[^a-z0-9]#-#g' \
            | sed 's/--*/-/g' \
            | sed 's/^-//;s/-$//' \
            | cut -c1-63)

          echo "NAMESPACE=$NAMESPACE" >> $GITHUB_OUTPUT

      - name: Update kt config with controller test namespace, if exists
        shell: bash
        id: controller-ns
        run: |

          NAMESPACE=${{ steps.generate_ns.outputs.NAMESPACE }}

          # Check if namespace exists
          if kubectl get namespace "$NAMESPACE" >/dev/null 2>&1; then
            echo "Namespace $NAMESPACE exists, setting kt config"
            kt config set namespace "$NAMESPACE"
            kt config set install_namespace "$NAMESPACE"
          else
            echo "Namespace $NAMESPACE does not exist, kt config remains unchanged"
          fi

      - name: Run python-path tests
        run: |
          cd python_client
          pytest -v tests/test_python_path.py --durations=25 --level minimal -m "not gpu_test"
        timeout-minutes: 60
        env:
          KT_STREAM_LOGS: false
          KT_STREAM_METRICS: false

  secret-tests:
    concurrency:
      group: secret-${{ github.ref }}
      cancel-in-progress: true
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Check out repository code
        uses: actions/checkout@v3

      - name: Install Basic Dependencies
        uses: ./.github/workflows/install_basic_dependencies

      - name: Setup authentications
        uses: ./.github/workflows/gke_authentications
        with:
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          GCP_WORKLOAD_IDENTITY_PROVIDER: ${{ secrets.GOOGLE_WORKLOAD_IDENTITY_PROVIDER }}

      - name: Setup Test Cluster
        uses: ./.github/workflows/setup_test_cluster
        with:
          KUBECONFIG: ${{ secrets.KUBECONFIG }}

      - name: Get GKE credentials
        run: |
          gcloud container clusters get-credentials ${{ secrets.CI_CLUSTER_NAME }} \
            --region ${{ secrets.CI_CLUSTER_REGION }} \
            --project ${{ secrets.GCP_PROJECT_ID }}

      - name: Set Python Source Root
        run: echo "PYTHONPATH=$(pwd)/python_client" >> $GITHUB_ENV

      - name: Set Test Hash
        run: |
          TEST_HASH="t-$(echo $GITHUB_SHA | cut -c1-5)-secret"
          echo "TEST_HASH=$TEST_HASH" >> $GITHUB_ENV

      - name: Generate Namespace value from branch name
        shell: bash
        id: generate_ns
        run: |
          BRANCH="${GITHUB_HEAD_REF:-$GITHUB_REF_NAME}"

          # create namespace only of the branch in in a format {namespace}---{featurename}".
          # Namespace will be {namespace}

          if [[ "$BRANCH" == *"---"* ]]; then
            # Get part before '---'
            NAMESPACE="${BRANCH%%---*}"
            # If branch has a slash (e.g., sb/prefix---feature), keep what's after '/'
            NAMESPACE="${NAMESPACE##*/}"
          else
            NAMESPACE="${BRANCH##*/}"
          fi

          # Sanitize for k8s namespace
          NAMESPACE=$(echo "$NAMESPACE" \
            | tr '[:upper:]' '[:lower:]' \
            | sed 's#[^a-z0-9]#-#g' \
            | sed 's/--*/-/g' \
            | sed 's/^-//;s/-$//' \
            | cut -c1-63)

          echo "NAMESPACE=$NAMESPACE" >> $GITHUB_OUTPUT

      - name: Update kt config with controller test namespace, if exists
        shell: bash
        id: controller-ns
        run: |

          NAMESPACE=${{ steps.generate_ns.outputs.NAMESPACE }}
          # Check if namespace exists
          if kubectl get namespace "$NAMESPACE" >/dev/null 2>&1; then
            echo "Namespace $NAMESPACE exists, setting kt config"
            kt config set namespace "$NAMESPACE"
            kt config set install_namespace "$NAMESPACE"
          else
            echo "Namespace $NAMESPACE does not exist, kt config remains unchanged"
          fi

      - name: Run secret tests
        run: |
          cd python_client
          pytest -v tests/test_secret.py --durations=25 --level minimal -m "not gpu_test"
        timeout-minutes: 60
        env:
          KT_STREAM_LOGS: false
          KT_STREAM_METRICS: false
          client_id: "my-client-id"
          client_secret: "my-client-secret"

  declarative-tests:
    concurrency:
      group: declarative-${{ github.ref }}
      cancel-in-progress: true
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Check out repository code
        uses: actions/checkout@v3

      - name: Install Basic Dependencies
        uses: ./.github/workflows/install_basic_dependencies

      - name: Setup authentications
        uses: ./.github/workflows/gke_authentications
        with:
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          GCP_WORKLOAD_IDENTITY_PROVIDER: ${{ secrets.GOOGLE_WORKLOAD_IDENTITY_PROVIDER }}

      - name: Setup Test Cluster
        uses: ./.github/workflows/setup_test_cluster
        with:
          KUBECONFIG: ${{ secrets.KUBECONFIG }}

      - name: Get GKE credentials
        run: |
          gcloud container clusters get-credentials ${{ secrets.CI_CLUSTER_NAME }} \
            --region ${{ secrets.CI_CLUSTER_REGION }} \
            --project ${{ secrets.GCP_PROJECT_ID }}

      - name: Set Python Source Root
        run: echo "PYTHONPATH=$(pwd)/python_client" >> $GITHUB_ENV

      - name: Set Test Hash
        run: |
          TEST_HASH="t-$(echo $GITHUB_SHA | cut -c1-5)-decl"
          echo "TEST_HASH=$TEST_HASH" >> $GITHUB_ENV

      - name: Generate Namespace value from branch name
        shell: bash
        id: generate_ns
        run: |
          BRANCH="${GITHUB_HEAD_REF:-$GITHUB_REF_NAME}"

          # create namespace only of the branch in in a format {namespace}---{featurename}".
          # Namespace will be {namespace}

          if [[ "$BRANCH" == *"---"* ]]; then
            # Get part before '---'
            NAMESPACE="${BRANCH%%---*}"
            # If branch has a slash (e.g., sb/prefix---feature), keep what's after '/'
            NAMESPACE="${NAMESPACE##*/}"
          else
            NAMESPACE="${BRANCH##*/}"
          fi

          # Sanitize for k8s namespace
          NAMESPACE=$(echo "$NAMESPACE" \
            | tr '[:upper:]' '[:lower:]' \
            | sed 's#[^a-z0-9]#-#g' \
            | sed 's/--*/-/g' \
            | sed 's/^-//;s/-$//' \
            | cut -c1-63)

          echo "NAMESPACE=$NAMESPACE" >> $GITHUB_OUTPUT

      - name: Update kt config with controller test namespace, if exists
        shell: bash
        id: controller-ns
        run: |

          NAMESPACE=${{ steps.generate_ns.outputs.NAMESPACE }}

          # Check if namespace exists
          if kubectl get namespace "$NAMESPACE" >/dev/null 2>&1; then
            echo "Namespace $NAMESPACE exists, setting kt config"
            kt config set namespace "$NAMESPACE"
            kt config set install_namespace "$NAMESPACE"
          else
            echo "Namespace $NAMESPACE does not exist, kt config remains unchanged"
          fi

      - name: Run declarative tests
        run: |
          cd python_client
          pytest -v tests/test_declarative.py --durations=100 --level minimal -m "not gpu_test"
        timeout-minutes: 60
        env:
          KT_STREAM_LOGS: false
          KT_STREAM_METRICS: false

  app-tests:
    concurrency:
      group: app-${{ github.ref }}
      cancel-in-progress: true
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Check out repository code
        uses: actions/checkout@v3

      - name: Install Basic Dependencies
        uses: ./.github/workflows/install_basic_dependencies

      - name: Setup authentications
        uses: ./.github/workflows/gke_authentications
        with:
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          GCP_WORKLOAD_IDENTITY_PROVIDER: ${{ secrets.GOOGLE_WORKLOAD_IDENTITY_PROVIDER }}

      - name: Setup Test Cluster
        uses: ./.github/workflows/setup_test_cluster
        with:
          KUBECONFIG: ${{ secrets.KUBECONFIG }}

      - name: Get GKE credentials
        run: |
          gcloud container clusters get-credentials ${{ secrets.CI_CLUSTER_NAME }} \
            --region ${{ secrets.CI_CLUSTER_REGION }} \
            --project ${{ secrets.GCP_PROJECT_ID }}

      - name: Set Python Source Root
        run: echo "PYTHONPATH=$(pwd)/python_client" >> $GITHUB_ENV

      - name: Set Test Hash
        run: |
          TEST_HASH="t-$(echo $GITHUB_SHA | cut -c1-5)-app"
          echo "TEST_HASH=$TEST_HASH" >> $GITHUB_ENV

      - name: Generate Namespace value from branch name
        shell: bash
        id: generate_ns
        run: |
          BRANCH="${GITHUB_HEAD_REF:-$GITHUB_REF_NAME}"

          # create namespace only of the branch in in a format {namespace}---{featurename}".
          # Namespace will be {namespace}

          if [[ "$BRANCH" == *"---"* ]]; then
            # Get part before '---'
            NAMESPACE="${BRANCH%%---*}"
            # If branch has a slash (e.g., sb/prefix---feature), keep what's after '/'
            NAMESPACE="${NAMESPACE##*/}"
          else
            NAMESPACE="${BRANCH##*/}"
          fi

          # Sanitize for k8s namespace
          NAMESPACE=$(echo "$NAMESPACE" \
            | tr '[:upper:]' '[:lower:]' \
            | sed 's#[^a-z0-9]#-#g' \
            | sed 's/--*/-/g' \
            | sed 's/^-//;s/-$//' \
            | cut -c1-63)

          echo "NAMESPACE=$NAMESPACE" >> $GITHUB_OUTPUT

      - name: Update kt config with controller test namespace, if exists
        shell: bash
        id: controller-ns
        run: |

          NAMESPACE=${{ steps.generate_ns.outputs.NAMESPACE }}

          # Check if namespace exists
          if kubectl get namespace "$NAMESPACE" >/dev/null 2>&1; then
            echo "Namespace $NAMESPACE exists, setting kt config"
            kt config set namespace "$NAMESPACE"
            kt config set install_namespace "$NAMESPACE"
          else
            echo "Namespace $NAMESPACE does not exist, kt config remains unchanged"
          fi

      - name: Run app tests
        run: |
          cd python_client
          pytest -v tests/test_app.py --durations=100 --level minimal -m "not gpu_test"
        timeout-minutes: 60
        env:
          KT_STREAM_LOGS: false
          KT_STREAM_METRICS: false

  manifest-tests:
    concurrency:
      group: manifest-${{ github.ref }}
      cancel-in-progress: true
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Check out repository code
        uses: actions/checkout@v3

      - name: Install Basic Dependencies
        uses: ./.github/workflows/install_basic_dependencies

      - name: Install Additional Dependencies
        uses: ./.github/workflows/install_additional_dependencies

      - name: Install Ray
        run: |
          uv pip install --system ray

      - name: Setup authentications
        uses: ./.github/workflows/gke_authentications
        with:
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          GCP_WORKLOAD_IDENTITY_PROVIDER: ${{ secrets.GOOGLE_WORKLOAD_IDENTITY_PROVIDER }}

      - name: Setup Test Cluster
        uses: ./.github/workflows/setup_test_cluster
        with:
          KUBECONFIG: ${{ secrets.KUBECONFIG }}

      - name: Get GKE credentials
        run: |
          gcloud container clusters get-credentials ${{ secrets.CI_CLUSTER_NAME }} \
            --region ${{ secrets.CI_CLUSTER_REGION }} \
            --project ${{ secrets.GCP_PROJECT_ID }}

      - name: Set Python Source Root
        run: echo "PYTHONPATH=$(pwd)/python_client" >> $GITHUB_ENV

      - name: Set Test Hash
        run: |
          TEST_HASH="t-$(echo $GITHUB_SHA | cut -c1-5)-manifest"
          echo "TEST_HASH=$TEST_HASH" >> $GITHUB_ENV

      - name: Generate Namespace value from branch name
        shell: bash
        id: generate_ns
        run: |
          BRANCH="${GITHUB_HEAD_REF:-$GITHUB_REF_NAME}"

          # create namespace only of the branch in in a format {namespace}---{featurename}".
          # Namespace will be {namespace}

          if [[ "$BRANCH" == *"---"* ]]; then
            # Get part before '---'
            NAMESPACE="${BRANCH%%---*}"
            # If branch has a slash (e.g., sb/prefix---feature), keep what's after '/'
            NAMESPACE="${NAMESPACE##*/}"
          else
            NAMESPACE="${BRANCH##*/}"
          fi

          # Sanitize for k8s namespace
          NAMESPACE=$(echo "$NAMESPACE" \
            | tr '[:upper:]' '[:lower:]' \
            | sed 's#[^a-z0-9]#-#g' \
            | sed 's/--*/-/g' \
            | sed 's/^-//;s/-$//' \
            | cut -c1-63)

          echo "NAMESPACE=$NAMESPACE" >> $GITHUB_OUTPUT

      - name: Update kt config with controller test namespace, if exists
        shell: bash
        id: controller-ns
        run: |

          NAMESPACE=${{ steps.generate_ns.outputs.NAMESPACE }}

          # Check if namespace exists
          if kubectl get namespace "$NAMESPACE" >/dev/null 2>&1; then
            echo "Namespace $NAMESPACE exists, setting kt config"
            kt config set namespace "$NAMESPACE"
            kt config set install_namespace "$NAMESPACE"
          else
            echo "Namespace $NAMESPACE does not exist, kt config remains unchanged"
          fi


      - name: Ensure Kueue LocalQueue exists in controller namespace
        shell: bash
        run: |
          CONTROLLER_NS="${{ steps.generate_ns.outputs.NAMESPACE }}"

          if kubectl get namespace "$CONTROLLER_NS" >/dev/null 2>&1; then
            echo "Ensuring LocalQueue gpu-queue in $CONTROLLER_NS"

            kubectl apply -f - <<EOF
          apiVersion: kueue.x-k8s.io/v1beta2
          kind: LocalQueue
          metadata:
            name: gpu-queue
            namespace: "$CONTROLLER_NS"
          spec:
            clusterQueue: gpu-cluster-queue
          EOF
          else
            echo "Controller namespace $CONTROLLER_NS does not exist, skipping LocalQueue"
          fi

      - name: Run manifest tests
        run: |
          cd python_client
          pytest -v tests/test_byo_manifest.py --durations=25 --level minimal -m "not gpu_test"
        timeout-minutes: 60
        env:
          KT_STREAM_LOGS: false
          KT_STREAM_METRICS: false


  imperative-tests:
    concurrency:
      group: imperative-${{ github.ref }}
      cancel-in-progress: true
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Check out repository code
        uses: actions/checkout@v3

      - name: Install Basic Dependencies
        uses: ./.github/workflows/install_basic_dependencies

      - name: Setup authentications
        uses: ./.github/workflows/gke_authentications
        with:
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          GCP_WORKLOAD_IDENTITY_PROVIDER: ${{ secrets.GOOGLE_WORKLOAD_IDENTITY_PROVIDER }}

      - name: Setup Test Cluster
        uses: ./.github/workflows/setup_test_cluster
        with:
          KUBECONFIG: ${{ secrets.KUBECONFIG }}

      - name: Get GKE credentials
        run: |
          gcloud container clusters get-credentials ${{ secrets.CI_CLUSTER_NAME }} \
            --region ${{ secrets.CI_CLUSTER_REGION }} \
            --project ${{ secrets.GCP_PROJECT_ID }}

      - name: Set Python Source Root
        run: echo "PYTHONPATH=$(pwd)/python_client" >> $GITHUB_ENV

      - name: Set Test Hash
        run: |
          TEST_HASH="t-$(echo $GITHUB_SHA | cut -c1-5)-imp"
          echo "TEST_HASH=$TEST_HASH" >> $GITHUB_ENV

      - name: Generate Namespace value from branch name
        shell: bash
        id: generate_ns
        run: |
          BRANCH="${GITHUB_HEAD_REF:-$GITHUB_REF_NAME}"
          if [[ "$BRANCH" == *"---"* ]]; then
            NAMESPACE="${BRANCH%%---*}"
            NAMESPACE="${NAMESPACE##*/}"
          else
            NAMESPACE="${BRANCH##*/}"
          fi
          NAMESPACE=$(echo "$NAMESPACE" \
            | tr '[:upper:]' '[:lower:]' \
            | sed 's#[^a-z0-9]#-#g' \
            | sed 's/--*/-/g' \
            | sed 's/^-//;s/-$//' \
            | cut -c1-63)
          echo "NAMESPACE=$NAMESPACE" >> $GITHUB_OUTPUT

      - name: Update kt config with controller test namespace, if exists
        shell: bash
        run: |
          NAMESPACE=${{ steps.generate_ns.outputs.NAMESPACE }}
          if kubectl get namespace "$NAMESPACE" >/dev/null 2>&1; then
            kt config set namespace "$NAMESPACE"
            kt config set install_namespace "$NAMESPACE"
          fi

      - name: Run imperative tests
        run: |
          cd python_client
          pytest -v --durations=25 --level minimal -m "not gpu_test" tests/test_imperative.py
        timeout-minutes: 60
        env:
          KT_STREAM_LOGS: false
          KT_STREAM_METRICS: false

  controller-tests:
    concurrency:
      group: controller-${{ github.ref }}
      cancel-in-progress: true
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Check out repository code
        uses: actions/checkout@v3

      - name: Install Basic Dependencies
        uses: ./.github/workflows/install_basic_dependencies

      - name: Setup authentications
        uses: ./.github/workflows/gke_authentications
        with:
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          GCP_WORKLOAD_IDENTITY_PROVIDER: ${{ secrets.GOOGLE_WORKLOAD_IDENTITY_PROVIDER }}

      - name: Setup Test Cluster
        uses: ./.github/workflows/setup_test_cluster
        with:
          KUBECONFIG: ${{ secrets.KUBECONFIG }}

      - name: Get GKE credentials
        run: |
          gcloud container clusters get-credentials ${{ secrets.CI_CLUSTER_NAME }} \
            --region ${{ secrets.CI_CLUSTER_REGION }} \
            --project ${{ secrets.GCP_PROJECT_ID }}

      - name: Set Python Source Root
        run: echo "PYTHONPATH=$(pwd)/python_client" >> $GITHUB_ENV

      - name: Set Test Hash
        run: |
          TEST_HASH="t-$(echo $GITHUB_SHA | cut -c1-5)-ctrl"
          echo "TEST_HASH=$TEST_HASH" >> $GITHUB_ENV

      - name: Generate Namespace value from branch name
        shell: bash
        id: generate_ns
        run: |
          BRANCH="${GITHUB_HEAD_REF:-$GITHUB_REF_NAME}"
          if [[ "$BRANCH" == *"---"* ]]; then
            NAMESPACE="${BRANCH%%---*}"
            NAMESPACE="${NAMESPACE##*/}"
          else
            NAMESPACE="${BRANCH##*/}"
          fi
          NAMESPACE=$(echo "$NAMESPACE" \
            | tr '[:upper:]' '[:lower:]' \
            | sed 's#[^a-z0-9]#-#g' \
            | sed 's/--*/-/g' \
            | sed 's/^-//;s/-$//' \
            | cut -c1-63)
          echo "NAMESPACE=$NAMESPACE" >> $GITHUB_OUTPUT

      - name: Update kt config with controller test namespace, if exists
        shell: bash
        run: |
          NAMESPACE=${{ steps.generate_ns.outputs.NAMESPACE }}
          if kubectl get namespace "$NAMESPACE" >/dev/null 2>&1; then
            kt config set namespace "$NAMESPACE"
            kt config set install_namespace "$NAMESPACE"
          fi

      - name: Run controller tests
        run: |
          cd python_client
          pytest -v --durations=25 --level minimal -m "not gpu_test" tests/test_controller.py tests/test_rbac.py tests/test_store.py
        timeout-minutes: 60
        env:
          KT_STREAM_LOGS: false
          KT_STREAM_METRICS: false

  compute-tests:
    concurrency:
      group: compute-${{ github.ref }}
      cancel-in-progress: true
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Check out repository code
        uses: actions/checkout@v3

      - name: Install Basic Dependencies
        uses: ./.github/workflows/install_basic_dependencies

      - name: Setup authentications
        uses: ./.github/workflows/gke_authentications
        with:
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          GCP_WORKLOAD_IDENTITY_PROVIDER: ${{ secrets.GOOGLE_WORKLOAD_IDENTITY_PROVIDER }}

      - name: Setup Test Cluster
        uses: ./.github/workflows/setup_test_cluster
        with:
          KUBECONFIG: ${{ secrets.KUBECONFIG }}

      - name: Get GKE credentials
        run: |
          gcloud container clusters get-credentials ${{ secrets.CI_CLUSTER_NAME }} \
            --region ${{ secrets.CI_CLUSTER_REGION }} \
            --project ${{ secrets.GCP_PROJECT_ID }}

      - name: Set Python Source Root
        run: echo "PYTHONPATH=$(pwd)/python_client" >> $GITHUB_ENV

      - name: Set Test Hash
        run: |
          TEST_HASH="t-$(echo $GITHUB_SHA | cut -c1-5)-comp"
          echo "TEST_HASH=$TEST_HASH" >> $GITHUB_ENV

      - name: Generate Namespace value from branch name
        shell: bash
        id: generate_ns
        run: |
          BRANCH="${GITHUB_HEAD_REF:-$GITHUB_REF_NAME}"
          if [[ "$BRANCH" == *"---"* ]]; then
            NAMESPACE="${BRANCH%%---*}"
            NAMESPACE="${NAMESPACE##*/}"
          else
            NAMESPACE="${BRANCH##*/}"
          fi
          NAMESPACE=$(echo "$NAMESPACE" \
            | tr '[:upper:]' '[:lower:]' \
            | sed 's#[^a-z0-9]#-#g' \
            | sed 's/--*/-/g' \
            | sed 's/^-//;s/-$//' \
            | cut -c1-63)
          echo "NAMESPACE=$NAMESPACE" >> $GITHUB_OUTPUT

      - name: Update kt config with controller test namespace, if exists
        shell: bash
        run: |
          NAMESPACE=${{ steps.generate_ns.outputs.NAMESPACE }}
          if kubectl get namespace "$NAMESPACE" >/dev/null 2>&1; then
            kt config set namespace "$NAMESPACE"
            kt config set install_namespace "$NAMESPACE"
          fi

      - name: Ensure Kueue LocalQueue exists in controller namespace
        shell: bash
        run: |
          CONTROLLER_NS="${{ steps.generate_ns.outputs.NAMESPACE }}"
          if kubectl get namespace "$CONTROLLER_NS" >/dev/null 2>&1; then
            kubectl apply -f - <<EOF
          apiVersion: kueue.x-k8s.io/v1beta2
          kind: LocalQueue
          metadata:
            name: gpu-queue
            namespace: "$CONTROLLER_NS"
          spec:
            clusterQueue: gpu-cluster-queue
          EOF
          fi

      - name: Run compute tests
        run: |
          cd python_client
          pytest -v --durations=25 --level minimal -m "not gpu_test" tests/test_compute.py tests/test_byo_compute.py tests/test_autoscale.py tests/test_autodown.py tests/test_kueue.py
        timeout-minutes: 60
        env:
          KT_STREAM_LOGS: false
          KT_STREAM_METRICS: false

  cleanup:
    if: ${{ always() }}
    needs: [cli-tests, distributed-tests, monitoring-tests, pod-from-pod-tests, python-path-tests, secret-tests, declarative-tests, app-tests, manifest-tests, imperative-tests, controller-tests, compute-tests]
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout repository code
        uses: actions/checkout@v3

      - name: Install Basic Dependencies
        uses: ./.github/workflows/install_basic_dependencies

      - name: Setup authentications
        uses: ./.github/workflows/gke_authentications
        with:
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          GCP_WORKLOAD_IDENTITY_PROVIDER: ${{ secrets.GOOGLE_WORKLOAD_IDENTITY_PROVIDER }}

      - name: Setup Test Cluster
        uses: ./.github/workflows/setup_test_cluster
        with:
          KUBECONFIG: ${{ secrets.KUBECONFIG }}

      - name: Get GKE credentials
        run: |
          gcloud container clusters get-credentials ${{ secrets.CI_CLUSTER_NAME }} \
            --region ${{ secrets.CI_CLUSTER_REGION }} \
            --project ${{ secrets.GCP_PROJECT_ID }}

      - name: Set Test Hash
        run: |
          TEST_HASH="t-$(echo $GITHUB_SHA | cut -c1-5)"
          echo "TEST_HASH=$TEST_HASH" >> $GITHUB_ENV
          echo "Using test hash $TEST_HASH"

      - name: Generate Namespace value from branch name
        shell: bash
        id: generate_ns
        run: |
          BRANCH="${GITHUB_HEAD_REF:-$GITHUB_REF_NAME}"

          # create namespace only of the branch in in a format {namespace}---{featurename}".
          # Namespace will be {namespace}

          if [[ "$BRANCH" == *"---"* ]]; then
            # Get part before '---'
            NAMESPACE="${BRANCH%%---*}"
            # If branch has a slash (e.g., sb/prefix---feature), keep what's after '/'
            NAMESPACE="${NAMESPACE##*/}"
          else
            NAMESPACE="${BRANCH##*/}"
          fi

          # Sanitize for k8s namespace
          NAMESPACE=$(echo "$NAMESPACE" \
            | tr '[:upper:]' '[:lower:]' \
            | sed 's#[^a-z0-9]#-#g' \
            | sed 's/--*/-/g' \
            | sed 's/^-//;s/-$//' \
            | cut -c1-63)

          echo "NAMESPACE=$NAMESPACE" >> $GITHUB_OUTPUT

      - name: Update kt config with controller test namespace, if exists
        shell: bash
        id: controller-ns
        run: |

          NAMESPACE=${{ steps.generate_ns.outputs.NAMESPACE }}

          # Check if namespace exists
          if kubectl get namespace "$NAMESPACE" >/dev/null 2>&1; then
            echo "Namespace $NAMESPACE exists, setting kt config"
            kt config set namespace "$NAMESPACE"
            kt config set install_namespace "$NAMESPACE"
          else
            echo "Namespace $NAMESPACE does not exist, kt config remains unchanged"
          fi

      - name: Configure test namespace RBAC
        run: |
          TEST_NS="kt-test-$TEST_HASH"
          echo "Creating test namespace $TEST_NS and configuring RBAC..."
          kubectl create namespace $TEST_NS --dry-run=client -o yaml | kubectl apply -f -

          # Use controller-ns output or fallback to 'kubetorch' (service account setup)
          CONTROLLER_NS="${{ steps.controller-ns.outputs.NAMESPACE }}"
          CONTROLLER_NS="${CONTROLLER_NS:-kubetorch}"

          # Create Role for the test namespace
          kubectl apply -f - <<EOF
          apiVersion: rbac.authorization.k8s.io/v1
          kind: Role
          metadata:
            name: kubetorch-controller-role-$TEST_NS
            namespace: $TEST_NS
          rules:
            - apiGroups: [""]
              resources: ["persistentvolumeclaims", "pods", "services", "configmaps", "secrets", "events"]
              verbs: ["get", "list", "watch", "create", "update", "patch", "delete", "deletecollection"]
            - apiGroups: [""]
              resources: ["pods/exec", "pods/log"]
              verbs: ["create", "get"]
            - apiGroups: ["apps"]
              resources: ["deployments", "deployments/status", "replicasets", "replicasets/status"]
              verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
            - apiGroups: ["networking.k8s.io"]
              resources: ["ingresses"]
              verbs: ["get", "list", "watch"]
          ---
          apiVersion: rbac.authorization.k8s.io/v1
          kind: RoleBinding
          metadata:
            name: kubetorch-controller-rolebinding-$TEST_NS
            namespace: $TEST_NS
          roleRef:
            apiGroup: rbac.authorization.k8s.io
            kind: Role
            name: kubetorch-controller-role-$TEST_NS
          subjects:
            - kind: ServiceAccount
              name: kubetorch-controller
              namespace: $CONTROLLER_NS
          EOF

      - name: Run Teardown Commands
        run: |
          for suffix in -mon -cli -pod -dist -python -secret -decl -app -manifest -imp -ctrl -comp; do
            echo "Running teardown command: kt teardown --prefix ${TEST_HASH}${suffix} --force"
            kt teardown --prefix ${TEST_HASH}${suffix} --force || true
            echo "Running teardown command: kt teardown --prefix ${TEST_HASH}${suffix} --namespace test-${TEST_HASH}${suffix} --force"
            kt teardown --prefix ${TEST_HASH}${suffix} --namespace test-${TEST_HASH}${suffix} --force || true
          done
          kt config set username ${TEST_HASH}-secret
          kt secrets delete -A -y

      - name: Delete BYO pods
        run: |
          NS=$(kt config get namespace | tail -1 | tr -d '[:space:]')
          kubectl get pods -n "$NS" --no-headers -o custom-columns=":metadata.name" | grep "^${TEST_HASH}" | xargs -r kubectl delete pod --force --grace-period=0 -n "$NS"

      - name: Delete test ns
        run: |
          kubectl get ns --no-headers -o custom-columns=":metadata.name" \
            | grep "^kt-test-${TEST_HASH}" \
            | xargs -r kubectl delete ns
