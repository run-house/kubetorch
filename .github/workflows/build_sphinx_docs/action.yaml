name: "Build and Sync Sphinx Documentation"
description: "Build Sphinx documentation (JSON) and sync it to an external repository."

inputs:
  kt_version:
    description: "Version number for the documentation"
    required: false
    default: "latest"
  dest_repo_token:
    description: "GitHub token to push to destination repository"
    required: true

runs:
  using: "composite"
  steps:
    - name: Checkout source repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"

    - name: Install kubetorch
      shell: bash
      run: |
        python -m pip install --upgrade pip
        python -m pip install uv
        uv pip install --system -e ./python_client[client]

    - name: Install docs requirements
      shell: bash
      run: |
        pip install -r python_client/kubetorch/docs/requirements.txt

    - name: Determine version
      id: version
      shell: bash
      run: |
        if [ "${{ inputs.kt_version }}" = "latest" ]; then
          VERSION="${{ github.sha }}"
        else
          VERSION="${{ inputs.kt_version }}"
        fi
        echo "version=$VERSION" >> "$GITHUB_OUTPUT"
        echo "Building documentation for version: $VERSION"

    - name: Build Sphinx documentation (JSON)
      shell: bash
      run: |
        cd python_client/kubetorch/docs
        make json
        find _build/json -name "*.fjson" -o -name "*.json" | head -10

    - name: Prepare JSON files
      shell: bash
      run: |
        mkdir -p staging
        JSON_DIR="python_client/kubetorch/docs/_build/json"
        if [ ! -d "$JSON_DIR" ]; then
          echo "Error: JSON build directory not found: $JSON_DIR"
          exit 1
        fi
        cp -r "$JSON_DIR"/* staging/
        cat > staging/build-info.json << EOF
        {
          "version": "${{ steps.version.outputs.version }}",
          "build_time": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
          "source_commit": "${{ github.sha }}",
          "source_repo": "${{ github.repository }}",
          "builder": "sphinx-json",
          "workflow_run": "${{ github.run_id }}"
        }
        EOF

    - name: Checkout destination repository
      uses: actions/checkout@v4
      with:
        repository: run-house/kubetorch-docs
        token: ${{ inputs.dest_repo_token }}
        path: dest-repo
        ref: main

    - name: Sync files to destination repository
      shell: bash
      run: |
        cd dest-repo
        git config user.name "Documentation Bot"
        git config user.email "action@github.com"
        mkdir -p v${{ steps.version.outputs.version }}
        rm -rf v${{ steps.version.outputs.version }}/*
        cp -r ../staging/* v${{ steps.version.outputs.version }}/

    - name: Commit and push changes
      shell: bash
      run: |
        cd dest-repo
        git add v${{ steps.version.outputs.version }}/
        if git diff --staged --quiet; then
          echo "No changes to commit"
          exit 0
        fi
        git commit -m "Update documentation for version ${{ steps.version.outputs.version }}
        Source: ${{ github.repository }}@${{ github.sha }}
        Workflow: ${{ github.run_id }}
        Build time: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
                git push origin main

    - name: Create summary
      shell: bash
      run: |
        echo "## Documentation Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Version:** ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Source Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Files Synced:** $(find staging -type f | wc -l)" >> $GITHUB_STEP_SUMMARY
        echo "- **Destination:** dest-repo/v${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Build Time:** $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_STEP_SUMMARY
