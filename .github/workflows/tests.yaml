name: Run tests

on:
  push:
    branches: [ main ]
  pull_request:

env:
  TOKEN: ${{ secrets.TOKEN }}

jobs:
  tests:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository code
        uses: actions/checkout@v3
      - name: Install Runhouse
        run: python -m pip install --upgrade pip && pip install -e .
      - name: Install test dependencies
        run: pip install pytest s3fs==2023.1.0 awscli==1.25.60 boto3==1.24.59 pycryptodome==3.12.0 \
             google-api-python-client google-cloud-storage gcsfs datasets dask
      - name: Login and download secrets
        run: python -c "import runhouse as rh; rh.login(token='$TOKEN', download_config=False, upload_config=False, download_secrets=True, upload_secrets=False)"
      - name: Sky check
        run: sky check
